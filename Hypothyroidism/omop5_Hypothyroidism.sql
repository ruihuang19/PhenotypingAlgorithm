                    
SET search_path TO omop;
/* *** pre_BLOCK 1: save drug codes in a table to avoid long WHERE clause *** */
-- IF OBJECT_ID('tempdb..#ph_hyporxcase') IS NOT NULL
-- 	DROP TABLE ph_hyporxcase;
CREATE TABLE ph_hyporxcase  (code INTEGER);
INSERT INTO ph_hyporxcase (code) VALUES (734703),(1501428),(1501429),(1501430),(1501458),(1501452),(1501454),(1501457),(1501453),(1501459),(1501431),(1501497),(1501493),(1501460),(1501461),(1501494),(1501499),(1501492),(1501496),(1501498),(1501500),(1501542),(1501543),(1501544),(1501545),(1501501),(1501546),(1501547),(1501548),(1501550),(1501551),(1501573),(1501579),(1501549),(1501572),(1501574),(1501575),(1501577),(1501576),(1501603),(1501604),(1501580),(1501581),(1501602),(1501605),(1501606),(1501607),(1501667),(1501608),(1501609),(1501668),(1501670),(1501669),(1501671),(1502144),(1502147),(1502149),(1502175),(1502176),(1502151),(1502204),(1502202),(1502179),(1502181),(1502305),(1505373),(1505374),(1505380),(1505381),(1505402),(1505403),(1505379),(1505404),(1505405),(1505433),(1505410),(1505434),(1505435),(1505436),(1505409),(1505437),(1505439),(1505411),(1505468),(1505469),(1505464),(1505465),(1505463),(1586834),(1586836),(1586810),(1586833),(1586811),(1586835),(1586809),(1586808),(1590443),(1590446),(1590444),(1590445),(1590447),(1590449),(1590450),(1590472),(1590451),(1590475),(1590481),(1590480),(1590476),(1590494),(1590495),(1590493),(1590473),(1590474),(1596792),(1596781),(1596800),(1596798),(1596801),(1596779),(1596813),(19006176),(19006177),(19006178),(19006180),(19006175),(19006211),(19006212),(19006213),(19006934),(19006935),(19011412),(19011413),(19011414),(19012196),(19017578),(19017576),(19017577),(19017575),(19017579),(19017580),(19017601),(19021434),(19032483),(19032490),(19032489),(19032516),(19032553),(19032552),(19032558),(19032557),(19032609),(19032608),(19032604),(19032646),(19032645),(19032649),(19032676),(19032680),(19032675),(19032701),(19032836),(19032858),(19032857),(19032859),(19032860),(19032867),(19032866),(19032881),(19032882),(19032883),(19033349),(19033350),(19033371),(19033724),(19033726),(19033725),(19033727),(19034577),(19035104),(19035105),(19035102),(19038860),(19038855),(19038857),(19038852),(19038853),(19038854),(19038856),(19038858),(19038859),(19038862),(19038864),(19038866),(19038868),(19038863),(19038865),(19038867),(19038861),(19046264),(19055098),(19055099),(19055100),(19055142),(19055143),(19055144),(19055145),(19055141),(19058712),(19061379),(19061401),(19061402),(19068306),(19071330),(19071329),(19071351),(19071355),(19071356),(19071357),(19071359),(19071358),(19071354),(19071360),(19071364),(19071381),(19071772),(19071777),(19074614),(19074613),(19074632),(19074631),(19074633),(19077089),(19077090),(19077121),(19078783),(19078786),(19078787),(19078789),(19078788),(19078790),(19078811),(19078814),(19079747),(19080100),(19082486),(19083549),(19083548),(19084124),(19084126),(19085619),(19085641),(19085642),(19085643),(19086444),(19087325),(19087326),(19087323),(19087329),(19087330),(19087351),(19087352),(19087354),(19087353),(19087355),(19087356),(19087408),(19089926),(19089927),(19089928),(19089929),(19091876),(19095978),(19096020),(19096295),(19096360),(19096371),(19096359),(19096372),(19096373),(19096731),(19097274),(19097260),(19097272),(19097375),(19097377),(19097373),(19097379),(19097737),(19099282),(19099283),(19103672),(19106205),(19106244),(19106257),(19106258),(19106695),(19107492),(19112146),(19112145),(19112147),(19112573),(19113334),(19113333),(19113534),(19113535),(19113537),(19113536),(19113539),(19113538),(19113755),(19113865),(19113864),(19114050),(19115166),(19118131),(19118130),(19118136),(19118135),(19118692),(19118691),(19120557),(19120698),(19120699),(19120776),(19120774),(19120882),(19120884),(19120880),(19120881),(19120883),(19121648),(19121651),(19121653),(19121650),(19121652),(19121649),(19121654),(19121655),(19121656),(19121658),(19121657),(19121961),(19121962),(19121960),(19122043),(19122044),(19123720),(19123722),(19123719),(19123721),(19123728),(19123724),(19123723),(19124094),(19124092),(19124093),(19124091),(19124096),(19124098),(19124095),(19124097),(19125475),(19125477),(19125474),(19125476),(19125879),(19125885),(19125881),(19125878),(19125884),(19125880),(19125887),(19125889),(19125891),(19125893),(19125886),(19125888),(19125890),(19125892),(19125911),(19125912),(19125913),(19125914),(19125915),(19125916),(19125917),(19125918),(19127283),(19127439),(19127438),(19127437),(19127436),(19127546),(19128397),(19128399),(19128396),(19128398),(19131735),(19131734),(19133168),(19133167),(40015917),(40025950),(40025949),(40026347),(40026348),(40026352),(40026353),(40026351),(40026350),(40034693),(40034692),(40041053),(40049610),(40086669),(40086633),(40086637),(40086682),(40086689),(40086670),(40086671),(40086672),(40086673),(40087011),(40087057),(40087177),(40087155),(40087178),(40087181),(40087180),(40087416),(40087470),(40087480),(40087478),(40087477),(40090114),(40098205),(40098209),(40098207),(40098211),(40098214),(40098213),(40101898),(40102125),(40109915),(40109914),(40111236),(40119160),(40119171),(40119164),(40121427),(40121431),(40121425),(40121426),(40121424),(40121443),(40121522),(40121872),(40122583),(40122567),(40122568),(40127195),(40127205),(40127206),(40130992),(40132266),(40132557),(40132558),(40138678),(40140046),(40153223),(40153233),(40155603),(40167756),(40167757),(40167758),(40169767),(40169768),(40169766),(40169765),(40169769),(40169771),(40169776),(40169773),(40169777),(40169770),(40169775),(40169774),(40169780),(40169784),(40169781),(40169785),(40169779),(40169783),(40169787),(40169778),(40169782),(40169786),(40169788),(40169792),(40169789),(40169793),(40169791),(40169795),(40169790),(40169794),(40169796),(40169800),(40169797),(40169801),(40169799),(40169798),(40173960),(40173959),(40173961),(40173962),(40173963),(40173955),(40173956),(40173954),(40173957),(40173958),(40174286),(40174287),(40174292),(40174293),(40174291),(40174294),(40174288),(40174289),(40174295),(40174290),(40174300),(40174299),(40174301),(40174298),(40174302),(40174304),(40174297),(40174303),(40174296),(40174305),(40174310),(40174311),(40174309),(40174307),(40174308),(40174306),(40174313),(40174312),(40174319),(40174320),(40174322),(40174318),(40174315),(40174314),(40174316),(40174321),(40174317),(40174323),(40174328),(40174329),(40174324),(40174327),(40174325),(40174326),(40174541),(40174542),(40174544),(40174546),(40174543),(40174547),(40174545),(40174558),(40174560),(40174564),(40174562),(40174559),(40174561),(40174565),(40174563),(40174568),(40174570),(40174566),(40174569),(40174571),(40174567),(40174687),(40174874),(40174876),(40174877),(40174879),(40174878),(40174880),(40174875),(40174873),(40174887),(40174889),(40174890),(40174898),(40174895),(40174897),(40174891),(40174894),(40174892),(40174896),(40174893),(40174899),(40174903),(40174906),(40174901),(40174900),(40174905),(40174907),(40174904),(40174902),(40174916),(40174910),(40174914),(40174913),(40174915),(40174917),(40174923),(40174920),(40174925),(40174922),(40174918),(40174921),(40174919),(40174924),(40174935),(40174930),(40174931),(40174934),(40174928),(40174933),(40174932),(40174929),(40174926),(40174927),(40174936),(40174938),(40174937),(40174949),(40174947),(40174944),(40174946),(40174945),(40174948),(40174951),(40174952),(40174953),(40174955),(40174961),(40174956),(40174958),(40174954),(40174957),(40174960),(40174971),(40174964),(40174968),(40174967),(40174962),(40174970),(40174963),(40174969),(40174978),(40174972),(40174981),(40174980),(40174988),(40174985),(40174987),(40174982),(40174983),(40174986),(40174994),(40174996),(40174993),(40174990),(40174992),(40174997),(40174995),(40174998),(40175000),(40175006),(40174999),(40175001),(40175011),(40175008),(40175010),(40175012),(40175013),(40175014),(40175025),(40175016),(40175021),(40175018),(40175024),(40175023),(40175028),(40175031),(40175026),(40175035),(40175034),(40175041),(40175043),(40175042),(40175040),(40175037),(40175046),(40175047),(40175045),(40175049),(40175048),(40175050),(40175044),(40175061),(40175059),(40175058),(40175057),(40175060),(40175052),(40175069),(40175063),(40175075),(40175078),(40175079),(40175072),(40175077),(40175074),(40175076),(40175086),(40175081),(40175084),(40175083),(40175082),(40175085),(40175097),(40175092),(40175096),(40175099),(40175102),(40175104),(40175100),(40175103),(40175101),(40175105),(40175098),(40175109),(40175107),(40175106),(40175108),(40175114),(40175113),(40175115),(40175112),(40175122),(40175120),(40175123),(40175121),(40175116),(40175129),(40175124),(40175127),(40175126),(40175125),(40175128),(40175130),(40175133),(40175131),(40175132),(40175137),(40175134),(40175136),(40175135),(40175150),(40175149),(40175151),(40175157),(40175158),(40175156),(40175153),(40175154),(40175159),(40175152),(40175155),(40175169),(40175165),(40175167),(40175168),(40175162),(40175163),(40175161),(40175160),(40175164),(40175166),(40175170),(40175171),(40175173),(40175172),(40175174),(40175184),(40175181),(40175183),(40175185),(40175186),(40175187),(40175192),(40175195),(40175189),(40175194),(40175191),(40175188),(40175190),(40175193),(40175204),(40175197),(40175198),(40175205),(40175202),(40175200),(40175196),(40175201),(40175203),(40175199),(40175206),(40175207),(40175209),(40175208),(40175210),(40175220),(40175218),(40175217),(40175219),(40175221),(40175222),(40175223),(40175225),(40175230),(40175227),(40175224),(40175226),(40175229),(40175235),(40175233),(40175234),(40175232),(40221416),(40221418),(40221420),(40221417),(40221419),(40221421),(40225041),(40230736),(40231176),(40231655),(40231654),(40234853),(40234859),(40234855),(40234857),(40234861),(40234854),(40234860),(40234856),(40234858),(40234867),(40234868),(40234862),(40238487),(40238489),(40238490),(40238492),(40238491),(40238488),(40240992),(40240995),(40240991),(40240994),(40241458),(40241464),(40241460),(40241465),(40241466),(40241461),(40241462),(40241467),(40241463),(40241459),(40241468),(40241469),(40243960),(40243962),(40243964),(40243966),(40243968),(40243961),(40243963),(40243965),(40243967),(40243969),(40243983),(40243985),(40243987),(40243984),(40243986),(40243988),(42706128),(42706126),(42706127),(42706089),(42706087),(42706088),(42706134),(42706132),(42706133),(42708345),(42708349),(42708347),(42708348),(42800922),(42800921),(42903452),(42708297),(42708295),(42708296),(42708343),(42708344),(42800937),(42800940),(42800943),(42800938),(42800941),(42800944),(42800939),(42800942),(42800945),(42900198),(42800934),(42800932),(42800935),(42800933),(42800936),(42800946),(42800949),(42800947),(42800950),(42800948),(43526213),(43526215),(43526225),(43526227),(43526226),(43526228),(43526760),(43526818),(43532172),(43532550),(43560756),(43560757),(43560758),(43560755),(43525827),(43526205),(43526206),(43526216),(43526218),(43526220),(43526222),(43526217),(43526219),(43526221),(43526223),(43532806),(43532807),(43532808),(43560674),(43560748),(43560752),(43560750),(43560746),(43560754),(43560749),(43560753),(43560751),(43560747),(44507632),(1501309),(1501700),(1505346),(19078428),(19102133),(40225043),(40225044),(40225042),(19011411);
INSERT INTO ph_hyporxcase (code) VALUES (1501310),(1501353),(1501311),(1501352),(1501610),(1501665),(1501611),(1505348),(1505408),(1505462),(1505441),(1590419),(1590420),(1590421),(1590418),(1590479),(1596799),(19019857),(19021572),(19023557),(19023555),(19023558),(19023553),(19023554),(19055097),(19057435),(19057436),(19057434),(19057437),(19057438),(19061378),(19061377),(19069223),(19071659),(19071660),(19071671),(19084948),(19084949),(19085646),(19087324),(19088209),(19098162),(19098214),(19098215),(19098216),(19099270),(19099281),(19110536),(19112750),(19112749),(19114048),(19120856),(19120857),(19121468),(19121467),(19121466),(19123967),(19123966),(40026346),(40026349),(40049603),(40086668),(40087179),(40090113),(40090130),(40090089),(40098204),(40098208),(40098206),(40098210),(40098212),(40121428),(40121429),(40121441),(40121442),(40121502),(40121513),(40121503),(40121514),(40121874),(40121875),(40121873),(40122595),(40122596),(40122623),(40122624),(40174881),(40174883),(40174885),(40174888),(40174884),(40174882),(40174886),(40174911),(40174908),(40174909),(40174912),(40174941),(40174943),(40174939),(40174942),(40174940),(40174959),(40174966),(40174965),(40174975),(40174976),(40174979),(40174973),(40174974),(40174977),(40174984),(40174989),(40174991),(40175004),(40175002),(40175005),(40175003),(40175007),(40175009),(40175015),(40175019),(40175022),(40175017),(40175020),(40175029),(40175027),(40175030),(40175038),(40175036),(40175039),(40175051),(40175054),(40175056),(40175055),(40175053),(40175067),(40175062),(40175066),(40175064),(40175068),(40175065),(40175070),(40175073),(40175071),(40175080),(40175087),(40175093),(40175095),(40175090),(40175088),(40175091),(40175089),(40175094),(40175110),(40175111),(40175117),(40175119),(40175118),(40175139),(40175138),(40175177),(40175175),(40175176),(40175179),(40175182),(40175178),(40175180),(40175213),(40175211),(40175212),(40175215),(40175214),(40175216),(40175228),(40175231),(40241632),(40241633),(40241641),(40241697),(40243980),(40243981),(42873271),(42873272),(42873508),(42873509),(43532170),(43532171);
;

-- IF OBJECT_ID('tempdb..#ph_ddrxthyroidaltering') IS NOT NULL
-- 	DROP TABLE ph_ddrxthyroidaltering;
CREATE TABLE ph_ddrxthyroidaltering  (code INTEGER);
INSERT INTO ph_ddrxthyroidaltering (code) VALUES (561422),(561426),(702773),(734519),(734514),(734543),(734709),(734784),(735051),(740392),(740939),(740936),(740969),(740992),(740995),(740970),(740971),(740996),(741024),(751282),(751283),(751284),(751291),(751364),(751365),(751367),(751368),(751369),(751370),(767446),(767447),(767448),(767445),(767449),(778352),(778353),(905365),(914450),(916703),(925960),(925986),(925991),(926023),(926605),(929515),(950216),(951522),(957439),(957440),(967012),(967013),(967350),(967422),(967435),(967555),(968475),(969576),(993471),(1001278),(1112837),(1113240),(1115098),(1127493),(1145406),(1156753),(1164847),(1237163),(1237202),(1237209),(1301001),(1301000),(1305449),(1305480),(1309998),(1310033),(1309997),(1310034),(1309999),(1310001),(1310000),(1310036),(1310038),(1310041),(1310037),(1310039),(1310938),(1310962),(1311005),(1321641),(1356482),(1389834),(1389833),(1396319),(1398679),(1398681),(1501457),(1501546),(1504621),(1504681),(1504712),(1504713),(1504672),(1504678),(1517983),(1517984),(1518018),(1554073),(1554072),(1554074),(1594978),(1595912),(1701955),(1701988),(1702091),(1703611),(1707433),(1707774),(1713589),(1713671),(1713701),(1713794),(1717410),(1717511),(1724697),(1724921),(1730002),(1729981),(1747208),(1747322),(1759843),(1759848),(1760099),(1760097),(1760096),(1760095),(1760137),(1760162),(1763848),(1763905),(1768910),(1768911),(1778166),(1789537),(1836987),(19000962),(19001225),(19001289),(19001373),(19001378),(19002680),(19003511),(19004703),(19006046),(19006202),(19006201),(19006203),(19006204),(19006205),(19006235),(19006237),(19006236),(19006424),(19006425),(19006515),(19006903),(19007001),(19007003),(19007265),(19007266),(19007388),(19007389),(19008203),(19008722),(19008980),(19009031),(19009495),(19011181),(19011186),(19011708),(19011780),(19011988),(19012206),(19013903),(19015765),(19015766),(19015767),(19015763),(19016158),(19017898),(19019523),(19020293),(19021563),(19021579),(19022018),(19022290),(19022587),(19022955),(19024818),(19025533),(19025561),(19026069),(19027881),(19027889),(19028074),(19028080),(19028152),(19028770),(19029601),(19029608),(19029814),(19030637),(19030638),(19031097),(19033439),(19033437),(19033438),(19033465),(19033464),(19034138),(19034139),(19034137),(19034267),(19034265),(19035381),(19036442),(19036475),(19037830),(19037851),(19037897),(19040080),(19040124),(19040123),(19042495),(19042496),(19042757),(19042756),(19042787),(19042789),(19042811),(19043249),(19043250),(19043271),(19043274),(19043272),(19043273),(19043437),(19043652),(19043655),(19044198),(19045147),(19045199),(19045406),(19045707),(19045709),(19045708),(19045732),(19046056),(19046090),(19046365),(19046417),(19047138),(19047163),(19047315),(19047411),(19047662),(19049673),(19049852),(19052457),(19052857),(19052856),(19054215),(19054216),(19054483),(19058050),(19058073),(19058266),(19058525),(19058686),(19058893),(19059181),(19059182),(19060469),(19060810),(19060828),(19060827),(19061260),(19061664),(19062070),(19062755),(19062939),(19062969),(19063593),(19064062),(19064063),(19064064),(19064668),(19064761),(19064833),(19064998),(19065829),(19065958),(19065987),(19066301),(19066877),(19067119),(19067595),(19069736),(19070430),(19070454),(19070451),(19070894),(19071561),(19072157),(19073587),(19074426),(19074499),(19074521),(19074527),(19074581),(19075640),(19075679),(19076397),(19076398),(19076399),(19076400),(19076407),(19076772),(19077306),(19077791),(19077794),(19077926),(19078647),(19078987),(19079089),(19079275),(19079276),(19079277),(19079279),(19079280),(19079278),(19080438),(19080617),(19080997),(19081293),(19082704),(19082793),(19082818),(19082943),(19084907),(19085031),(19085040),(19085494),(19085925),(19085930),(19088232),(19088268),(19088700),(19088817),(19090351),(19090448),(19090495),(19091062),(19092269),(19092392),(19092394),(19094424),(19094452),(19094453),(19094619),(19094971),(19095651),(19096715),(19096875),(19096979),(19097734),(19098242),(19098243),(19098379),(19098380),(19098400),(19098419),(19099130),(19099144),(19099145),(19099258),(19099540),(19099573),(19099890),(19099948),(19099980),(19099983),(19100258),(19100937),(19101724),(19102066),(19102289),(19102466),(19102477),(19102787),(19102824),(19103086),(19103182),(19103317),(19103780),(19104010),(19104054),(19104112),(19104113),(19104283),(19104603),(19104602),(19104604),(19105170),(19105401),(19105423),(19105467),(19105651),(19105754),(19105901),(19106168),(19106382),(19106432),(19106567),(19106600),(19106672),(19106673),(19106671),(19106684),(19106760),(19106935),(19106943),(19106952),(19107017),(19107037),(19107098),(19107114),(19107132),(19107142),(19107146),(19107287),(19107377),(19107537),(19107540),(19107606),(19107624),(19107880),(19107886),(19107987),(19107994),(19108020),(19108136),(19108157),(19108271),(19108274),(19108472),(19108541),(19108779),(19109023),(19109019),(19109215),(19109230),(19109424),(19109831),(19109910),(19110822),(19110820),(19110821),(19110884),(19111372),(19111455),(19111478),(19111479),(19111592),(19111624),(19111625),(19111633),(19111771),(19111783),(19112129),(19112126),(19112715),(19113232),(19113231),(19113543),(19113544),(19114470),(19114600),(19114599),(19115197),(19115295),(19115410),(19115421),(19115426),(19115441),(19115448),(19116088),(19116093),(19116143),(19116161),(19116199),(19116220),(19117486),(19117667),(19117734),(19117922),(19118197),(19118291),(19118468),(19118759),(19118761),(19119155),(19119173),(19119174),(19119369),(19119370),(19119371),(19119374),(19119372),(19119373),(19119429),(19119532),(19119540),(19119539),(19119799),(19119945),(19119952),(19120832),(19120902),(19120903),(19121132),(19121142),(19121235),(19121645),(19121647),(19121646),(19123251),(19123252),(19123331),(19123332),(19123589),(19123588),(19123640),(19123698),(19123701),(19123700),(19123697),(19124851),(19125230),(19125229),(19125287),(19125610),(19125845),(19125846),(19125864),(19126466),(19126465),(19126464),(19126899),(19127314),(19127313),(19127603),(19127664),(19127671),(19127670),(19127669),(19127934),(19127933),(19127947),(19128294),(19128295),(19128382),(19128381),(19129024),(19129782),(19129874),(19129872),(19129873),(19129871),(19130065),(19130066),(19130137),(19130140),(19131743),(19131742),(19132787),(19132786),(19132788),(19132794),(19132797),(19132793),(19132796),(19132795),(19132792),(19132801),(19132799),(19132803),(19132805),(19132800),(19132798),(19132802),(19132804),(19132806),(19132808),(19132807),(19133010),(19133009),(19133983),(19133984),(19133981),(19133982),(19134084),(19134087),(19134704),(19135188),(19135185),(19135184),(19135351),(19135354),(19135482),(19135481),(19135750),(19135752),(19135749),(19135751),(40000556),(40000518),(40000565),(40000562),(40000564),(40000560),(40002096),(40007480),(40007669),(40007672),(40007681),(40007685),(40007671),(40007684),(40007686),(40007691),(40007693),(40007697),(40007695),(40007687),(40007703),(40007698),(40007701),(40007704),(40007700),(40007699),(40009254),(40009256),(40009312),(40010503),(40010908),(40015604),(40015600),(40015602),(40015603),(40015605),(40015606),(40015607),(40016323),(40016672),(40018738),(40018985),(40018984),(40018986),(40019296),(40019620),(40019641),(40029828),(40030247),(40031075),(40031076),(40032627),(40032628),(40040799),(40040898),(40040899),(40042562),(40042563),(40042561),(40045585),(40049011),(40049009),(40049380),(40050972),(40050971),(40053037),(40055765),(40058988),(40058971),(40058979),(40058972),(40058990),(40058989),(40058991),(40059296),(40059297),(40060556),(40060555),(40061699),(40062813),(40064564),(40064566),(40068855),(40070681),(40070682),(40071993),(40074884),(40075210),(40075205),(40075226),(40075253),(40075252),(40075261),(40075254),(40075262),(40075255),(40075259),(40075264),(40075265),(40075266),(40075269),(40075271),(40075267),(40075263),(40075270),(40075272),(40076466),(40083591),(40083588),(40086490),(40086492),(40086493),(40086494),(40087208),(40087206),(40088613),(40088610),(40090069),(40092421),(40092422),(40094056),(40094057),(40094059),(40096724),(40098417),(40100688),(40103004),(40104755),(40104758),(40104811),(40104813),(40104809),(40104812),(40104814),(40104815),(40104810),(40104817),(40104816),(40104821),(40104819),(40104820),(40104818),(40105080),(40105081),(40105145),(40105293),(40106421),(40106416),(40106420),(40106418),(40106419),(40106451),(40106452),(40106591),(40106593),(40106594),(40106684),(40118046),(40119251),(40119293),(40119284),(40120026),(40121636),(40121634),(40121780),(40121783),(40125087),(40125088),(40125089),(40127186),(40127187),(40127931),(40127930),(40131117),(40131124),(40131118),(40131958),(40131959),(40132106),(40135218),(40135219),(40136281),(40136282),(40136283),(40136946),(40140380),(40141098),(40141270),(40141286),(40141328),(40141358),(40141357),(40141375),(40141376),(40142159),(40143271),(40145034),(40144948),(40147864),(40149207),(40149209),(40149208),(40150737),(40150738),(40153239),(40153240),(40155188),(40157264),(40157266),(40159393),(40162400),(40163204),(40163205),(40163206),(40163212),(40163217),(40163213),(40163216),(40163220),(40163219),(40163221),(40163225),(40163223),(40163218),(40163224),(40163222),(40163230),(40163235),(40163226),(40163234),(40163229),(40163227),(40163232),(40163231),(40163233),(40163228),(40163240),(40163237),(40163236),(40163242),(40163241),(40163243),(40163239),(40163238),(40163253),(40163245),(40163249),(40163244),(40163246),(40163250),(40163248),(40163252),(40163251),(40163247),(40164957),(40164958),(40164979),(40164981),(40164980),(40164978),(40164977),(40164983),(40164982),(40165472),(40165473),(40165471),(40166373),(40166374),(40166850),(40166849),(40166851),(40167250),(40167308),(40167311),(40167309),(40167310),(40167314),(40167312),(40167315),(40167313),(40167316),(40170260),(40170261),(40176381),(40176380),(40184720),(40184721),(40184723),(40184724),(40184722),(40229190),(40229189),(40229191),(40229186),(40229192),(40229193),(40234749),(40234750),(40235565),(40235564),(40235684),(40237286),(40237285),(40237287),(40237284),(40238791),(40238911),(40238910),(40238912),(40238921),(40238920),(40239136),(40239135),(40239423),(40239422),(40241523),(40241933),(40242150),(40243309),(42705889),(42901712),(42902367),(42903401),(43013371),(43013376),(42708102),(42708322),(42799490),(42799491),(42799939),(42799940),(42799938),(42900524),(42901674),(42902608),(42903299),(42903386),(43011665),(43012579),(43012942),(42900977),(42901034),(42901035),(42901033),(43012052),(43013967),(43013968),(43013966),(43013965),(43532402),(44507657),(44507658),(44507659),(43525970),(43531990),(43531991),(43533061),(43560291),(43560292),(44507656),(44507655),(740910),(751246),(767410),(1504620),(19060002),(19071904),(19071905),(19071903),(19113040),(19113039),(40224257),(40224929),(40227045),(19124477),(1309944);
INSERT INTO ph_ddrxthyroidaltering (code) VALUES (711455),(740940),(740998),(740997),(741031),(741022),(740999),(741001),(741023),(741000),(751249),(751250),(751247),(751251),(751363),(751362),(751382),(751387),(778732),(789690),(908692),(916870),(924597),(929441),(967166),(967473),(967652),(988125),(988124),(1001235),(1113173),(1140367),(1237052),(1237053),(1301004),(1301003),(1301002),(1309992),(1309994),(1309951),(1309946),(1309945),(1309947),(1309949),(1309948),(1309996),(1309995),(1319239),(1319274),(1319279),(1319305),(1352259),(1352258),(1352257),(1389253),(1399068),(1399067),(1504677),(1504675),(1506576),(1517865),(1595815),(1703607),(1713543),(1713588),(1713694),(1717407),(1717434),(1724918),(1729784),(1741411),(1778227),(1790903),(1836962),(1836995),(19000843),(19000857),(19001211),(19001149),(19001150),(19001217),(19002486),(19003082),(19006869),(19008430),(19010603),(19010638),(19011351),(19011511),(19012031),(19017900),(19018750),(19019111),(19021752),(19022620),(19025150),(19025781),(19025740),(19025782),(19025783),(19025784),(19025785),(19025858),(19026512),(19030442),(19030475),(19033706),(19034803),(19035914),(19042457),(19043570),(19043653),(19043654),(19043651),(19043710),(19043734),(19043733),(19043735),(19043736),(19043738),(19043737),(19043739),(19044822),(19044953),(19047290),(19047312),(19047311),(19047539),(19048397),(19049383),(19051826),(19052450),(19052486),(19052487),(19056379),(19056401),(19056972),(19056973),(19056976),(19058129),(19058737),(19058895),(19058938),(19059256),(19059785),(19060401),(19060402),(19061035),(19061036),(19062644),(19063147),(19063692),(19063847),(19064667),(19065689),(19069450),(19069481),(19071121),(19072297),(19072298),(19073181),(19073214),(19073215),(19073365),(19073364),(19073952),(19074108),(19074979),(19075084),(19076396),(19076955),(19076992),(19076991),(19077970),(19078371),(19078401),(19079834),(19081254),(19081677),(19081884),(19082376),(19084345),(19084378),(19085495),(19086960),(19087004),(19087244),(19087531),(19088478),(19089255),(19089481),(19090700),(19090905),(19095201),(19096158),(19098071),(19098936),(19098934),(19099141),(19099576),(19099772),(19099795),(19099842),(19100056),(19100071),(19101073),(19101079),(19101296),(19101318),(19101806),(19101984),(19102495),(19102771),(19102923),(19103034),(19103180),(19103336),(19103377),(19103604),(19103610),(19103731),(19104364),(19104539),(19104540),(19104541),(19104542),(19104549),(19104550),(19104551),(19105477),(19105731),(19105741),(19106114),(19106524),(19106707),(19106715),(19106790),(19106807),(19107068),(19107219),(19107307),(19107688),(19107689),(19107776),(19107952),(19107944),(19108419),(19108420),(19108527),(19108535),(19108709),(19108710),(19108907),(19109145),(19109307),(19109617),(19109625),(19110021),(19110494),(19110555),(19110553),(19110552),(19110554),(19110551),(19110548),(19110547),(19110558),(19110556),(19110561),(19110562),(19110927),(19111219),(19111376),(19111377),(19111378),(19111379),(19111380),(19111381),(19111382),(19111383),(19111386),(19111405),(19111406),(19111867),(19112189),(19115068),(19115066),(19115093),(19115636),(19115683),(19115948),(19116034),(19116036),(19116037),(19116035),(19116401),(19116675),(19117612),(19117645),(19117644),(19117646),(19117647),(19117648),(19117649),(19118249),(19118247),(19119541),(19119543),(19119542),(19119670),(19120489),(19120490),(19121193),(19123147),(19123146),(19123762),(19124973),(19125804),(19125803),(19125922),(19125921),(19125934),(19125933),(19127248),(19127604),(19127727),(19128966),(19128967),(19128968),(19129830),(19130232),(19130231),(19131704),(19131863),(19131862),(19131861),(19131860),(19132516),(19132519),(19132517),(19132518),(19132529),(19132528),(19132585),(19132584),(19132876),(19132875),(19132874),(19133019),(19133021),(19133023),(19133018),(19133020),(19133022),(19133832),(19134045),(19134319),(19134716),(19135972),(19135973),(40000539),(40000524),(40000557),(40000515),(40000522),(40000558),(40000559),(40000561),(40000563),(40000566),(40000567),(40000571),(40002007),(40002097),(40002095),(40002098),(40002099),(40007670),(40007682),(40007680),(40007683),(40007696),(40007692),(40007688),(40007702),(40009251),(40009252),(40009255),(40009311),(40009402),(40009458),(40009401),(40009456),(40009459),(40012587),(40016325),(40016326),(40016674),(40016673),(40020027),(40031074),(40037810),(40040800),(40049010),(40049381),(40049601),(40058983),(40058987),(40059003),(40058999),(40059001),(40059000),(40059295),(40059303),(40060848),(40061698),(40062814),(40064565),(40068856),(40071994),(40071995),(40072170),(40072169),(40075256),(40075257),(40075258),(40075260),(40075268),(40075514),(40077681),(40077682),(40082822),(40083576),(40086488),(40086489),(40086491),(40088611),(40090162),(40096723),(40098418),(40100689),(40103005),(40105355),(40106682),(40106683),(40111201),(40111200),(40111202),(40115561),(40118044),(40118045),(40119241),(40119243),(40119247),(40119292),(40119279),(40119908),(40119909),(40119910),(40121637),(40121781),(40121782),(40121784),(40121886),(40130084),(40130085),(40130083),(40133189),(40133188),(40135390),(40141094),(40141096),(40141414),(40149463),(40154600),(40157263),(40161141),(40161480),(40161481),(40163207),(40163209),(40163208),(40163211),(40163214),(40163215),(40163210),(40168610),(40168757),(40168758),(40169301),(40170258),(40170259),(40171011),(40171012),(40173554),(40173553),(40236745),(40237998),(40237997),(40237999),(40237996),(40238239),(40238241),(40238238),(40238240),(40238242),(40238237),(40238761),(40240146),(40240145),(40241524),(40241623),(40241835),(40241836),(40241934),(40243483),(42706311),(42707446),(42705939),(42706935),(42705643),(42707896),(42708288),(42708472),(42800144),(42800804),(42800803),(42874114),(42901706),(42901708),(42901707),(42901705),(42902565),(42902788),(43011590),(43011953),(43013051),(43013373),(43013372),(43013370),(43013374),(43013369),(43013375),(43013378),(43013377),(42707906),(42708125),(42709079),(42899307),(42901023),(42901024),(42901025),(42901704),(42708000),(42800145),(42800146),(42800237),(42898216),(42899189),(42903098),(43013050),(43013049),(43013048),(43013254),(43013253),(43013482),(43526580),(44506687);
;
/* *** BLOCK Data Preparation: pregnancy information first *** */
-- IF OBJECT_ID('tempdb..#ph_hypotmppregnancy') IS NOT NULL
-- 	DROP TABLE ph_hypotmppregnancy;
CREATE TABLE ph_hypotmppregnancy  (person_id INT
	,minPregnancyDate DATE
	,maxPregnancyDate DATE
	);
INSERT INTO ph_hypotmppregnancy
SELECT person_id
		,MIN(eventDate) AS minPregnancyDate
		,MAX(eventDate) AS maxPregnancyDate
		FROM (	
		SELECT person_id
			,condition_start_date AS eventDate
		FROM condition_occurrence
        WHERE condition_concept_id IN (21003452,21013555,21002562,21003086,21010583,4028644,136755,138484,138479,139895,193525,199076,200153,432375,432695,432969,434097,435018,437041,437611,437931,438481,439894,440462,440466,441919,442300,442594,138207,197031,432373,433822,435063,435875,440465,441647,4030415,4118058,4239301,40483581,433260,439348,4299535,436477,35506777,35506778,36818713,36818720,36818820,36818821,4045947,4047564,35809065,36818711,36818833,36818845,37420448,4302252,36818814,36818620)
		UNION ALL
		SELECT person_id
		-- 	,observation_date AS eventDate
		-- FROM observation
        -- WHERE observation_concept_id IN (40758989) AND value_as_number > 0.5
        -- should be in measurement table instead
        ,measurement_date AS eventDate
        FROM measurement
        WHERE measurement_concept_id IN (40758989) AND value_as_number > 0.5
		) J
		GROUP BY person_id
		;
/* *** BLOCK 1: Extract relevant data element FROM source data and store in #ph_hypotmp *** */
-- IF OBJECT_ID('tempdb..#ph_hypotmp') IS NOT NULL
-- 	DROP TABLE ph_hypotmp;
SET search_path to omop;
CREATE TABLE ph_hypotmp  (person_id INT
	,eventDate DATE
	,eventConceptId INT
	,eventType VARCHAR(100)
	,eventNumValue FLOAT NULL
	,eventStringValue VARCHAR(100) NULL
	);
INSERT INTO ph_hypotmp
SELECT DISTINCT *
FROM (
	SELECT P0.person_id
		,U.eventDate
		,U.eventConceptId
		,U.eventType
		,U.eventNumValue
		,U.eventStringValue
	FROM eMergeCohort2 P0
	LEFT JOIN (
		SELECT person_id
			,condition_start_date AS eventDate
			,condition_concept_id AS eventConceptId
			,'DxHypothyroidism' AS eventType
			,CAST(NULL AS FLOAT) AS eventNumValue
		    ,CAST(NULL AS varchar(100)) AS eventStringValue
		FROM condition_occurrence
        WHERE condition_concept_id IN (21000589,21000588,21000587,21000583,132583,132579,133444,133737,135215,135779,137520,137820,138711,140062,138384,140673,35506769,35506764,35506770,35506767,35506771,35506768,35506797,35506800)
		UNION ALL
		/*Case condition not IN 6 month before pregnancy to one year after pregnancy */
		SELECT person_id
			,condition_start_date AS eventDate
			,condition_concept_id AS eventConceptId
			,'DxHypothyroidismNoPregnancy' AS eventType
			,NULL AS eventNumValue
		    ,NULL AS eventStringValue
		FROM condition_occurrence
        WHERE condition_concept_id IN (21000589,21000588,21000587,21000583,132583,132579,133444,133737,135215,135779,137520,137820,138711,140062,138384,140673,35506769,35506764,35506770,35506767,35506771,35506768,35506797,35506800)
		AND person_id NOT IN (SELECT person_id FROM ph_hypotmppregnancy)
		UNION ALL
		SELECT person_id
			,condition_start_date AS eventDate
			,condition_concept_id AS eventConceptId
			,'DxHypothyroidismNoPregnancy' AS eventType
			,NULL AS eventNumValue
		    ,NULL AS eventStringValue
		FROM condition_occurrence CO
        WHERE condition_concept_id IN (21000589,21000588,21000587,21000583,132583,132579,133444,133737,135215,135779,137520,137820,138711,140062,138384,140673,35506769,35506764,35506770,35506767,35506771,35506768,35506797,35506800)
		AND person_id IN (SELECT person_id FROM ph_hypotmppregnancy)
		AND ((extract(year from age(CAST((SELECT minPregnancyDate FROM ph_hypotmppregnancy TP WHERE TP.person_id =CO.person_id) AS DATE), CAST(condition_start_date AS DATE)))*12 + extract(month from age(CAST((SELECT minPregnancyDate FROM ph_hypotmppregnancy TP WHERE TP.person_id =CO.person_id) AS DATE), CAST(condition_start_date AS DATE)))) > 6 
		OR (EXTRACT(YEAR FROM CAST(condition_start_date AS DATE)) - EXTRACT(YEAR FROM CAST((SELECT maxPregnancyDate FROM ph_hypotmppregnancy TP WHERE TP.person_id = CO.person_id) AS DATE))) > 1 )		
		UNION ALL
		SELECT person_id
			,condition_start_date AS eventDate
			,condition_concept_id AS eventConceptId
			,'DxCaseCtrlExcl' AS eventType
			,NULL AS eventNumValue
		    ,NULL AS eventStringValue
		FROM condition_occurrence
        WHERE condition_concept_id IN (21013716,40248954,21000499,21000554,21000581,21000610,21002963,40248953,40249011,22856,27826,30678,132583,133727,134312,134619,134608,135778,136932,137820,139774,140062,140976,4030042,24612,134618,138717,199775,28127,133436,4131812,133424,35305563,35506554,35506786,35506790,35506793,35506795,35506797,35506800,35305565,35305566,35305564,35506808)
		UNION ALL
		SELECT person_id
			,condition_start_date AS eventDate
			,condition_concept_id AS eventConceptId
			,'DxCtrlExcl' AS eventType
			,NULL AS eventNumValue
		    ,NULL AS eventStringValue
		FROM condition_occurrence
        WHERE condition_concept_id IN (21003009,21013716,40248955,21000581,21001150,21002963,43534897,21000589,21000588,21000587,21000583,21000591,21003004,21005289,21000422,21000577,21000578,21000584,76685,132583,132584,132579,133444,133727,133737,134312,134619,134608,134898,135215,135778,135772,135779,136368,136661,136932,136933,137519,137520,137820,138113,138387,138711,138718,139774,140062,140976,141825,4030042,134618,138717,140364,133436,138384,4099641,140673,4030055,4215003,133728,141253,4095918,35506769,35506764,35506770,35506767,35506771,35506768,35506774,35506782,35506786,35506790,35506793,35506795,35506797,35506800,35506810,36009825,4205728,35506772,37522104,36009826,35305570,35506777)
		UNION ALL
		SELECT person_id
			,condition_start_date AS eventDate
			,condition_concept_id AS eventConceptId
			,'DxPregnancy' AS eventType
			,NULL AS eventNumValue
		    ,NULL AS eventStringValue
		FROM condition_occurrence
        WHERE condition_concept_id IN (21003452,21013555,21002562,21003086,21010583,4028644,136755,138484,138479,139895,193525,199076,200153,432375,432695,432969,434097,435018,437041,437611,437931,438481,439894,440462,440466,441919,442300,442594,138207,197031,432373,433822,435063,435875,440465,441647,4030415,4118058,4239301,40483581,433260,439348,4299535,436477,35506777,35506778,36818713,36818720,36818820,36818821,4045947,4047564,35809065,36818711,36818833,36818845,37420448,4302252,36818814,36818620)
		UNION ALL
		SELECT person_id
			,drug_exposure_start_date AS eventDate
			,drug_concept_id AS eventConceptId
			,'RxCase' AS eventType
			,NULL AS eventNumValue
		    ,NULL AS eventStringValue
		FROM drug_exposure
		WHERE drug_concept_id IN (
				SELECT DISTINCT *
				FROM ph_hyporxcase
				)
		UNION ALL
	/*Case Rx Case not IN 6 month before pregnancy to one year after pregnancy */
		SELECT person_id
			,drug_exposure_start_date AS eventDate
			,drug_concept_id AS eventConceptId
			,'RxCaseNoPregnancy' AS eventType
			,NULL AS eventNumValue
		    ,NULL AS eventStringValue
		FROM drug_exposure
		WHERE drug_concept_id IN (
				SELECT DISTINCT *
				FROM ph_hyporxcase
				)
		AND person_id NOT IN (SELECT person_id FROM ph_hypotmppregnancy)
		UNION ALL
		SELECT person_id
			,drug_exposure_start_date AS eventDate
			,drug_concept_id AS eventConceptId
			,'RxCaseNoPregnancy' AS eventType
			,NULL AS eventNumValue
		    ,NULL AS eventStringValue
		FROM drug_exposure DE
		WHERE drug_concept_id IN (
				SELECT DISTINCT *
				FROM ph_hyporxcase
				)
		AND person_id IN (SELECT person_id FROM ph_hypotmppregnancy)
		AND ((extract(year from age(CAST((SELECT minPregnancyDate FROM ph_hypotmppregnancy TP WHERE TP.person_id = DE.person_id) AS DATE), CAST(drug_exposure_start_date AS DATE)))*12 + extract(month from age(CAST((SELECT minPregnancyDate FROM ph_hypotmppregnancy TP WHERE TP.person_id = DE.person_id) AS DATE), CAST(drug_exposure_start_date AS DATE)))) > 6 
		OR (EXTRACT(YEAR FROM CAST(drug_exposure_start_date AS DATE)) - EXTRACT(YEAR FROM CAST((SELECT maxPregnancyDate FROM ph_hypotmppregnancy TP WHERE TP.person_id = DE.person_id) AS DATE))) > 1 )
		UNION ALL
		SELECT person_id
			,drug_exposure_start_date AS eventDate
			,drug_concept_id AS eventConceptId
			,'RxAnyMed' AS eventType
			,NULL AS eventNumValue
		    ,NULL AS eventStringValue
		FROM drug_exposure
		WHERE drug_exposure_start_date IS NOT NULL AND drug_concept_id IS NOT NULL
		UNION ALL
		SELECT person_id
			,drug_exposure_start_date AS eventDate
			,drug_concept_id AS eventConceptId
			,'RxThyroidAltering' AS eventType
			,NULL AS eventNumValue
		    ,NULL AS eventStringValue
		FROM drug_exposure
		WHERE drug_concept_id IN (
				SELECT DISTINCT *
				FROM ph_ddrxthyroidaltering
				)
		UNION ALL
		SELECT person_id
			,procedure_date AS eventDate
			,procedure_concept_id AS eventConceptId
			,'ProcRadiation' AS eventType
			,NULL AS eventNumValue
		    ,NULL AS eventStringValue
		FROM procedure_occurrence P
        WHERE procedure_concept_id IN (2211835,2211834,2211832,2211833,2211831,2211839,2211843,2211841,2211842,2211840,2211837,2211838,2211836,2211852,2211847,2211846,2211845,2211851,2211850,2211848,2211849,2211844,2211853,2211862,2211861,2211860,2211859,2211857,2211858,2211870,2211867,2211869,2211868,2211866,2211865,2211864,2211872,2211880,2211878,2211877,2211876,2211871,2211881,2211882,2211883,2211884,2211885,2211893,2211896,2211894,2211892,2211897,2211895,2211891,2211906,2211907,2211905,42737621,42737624,42737623,42737622)
		UNION ALL
		SELECT person_id
			,procedure_date AS eventDate
			,procedure_concept_id AS eventConceptId
			,'ProcThyroidectomy' AS eventType
			,NULL AS eventNumValue
		    ,NULL AS eventStringValue
		FROM procedure_occurrence P
        WHERE procedure_concept_id IN (2211919,2110370,2110367,2110369,2110365,2110374,2110375,2110372,2110373,2110376,2110371,2110385,2110384,2110383,2110368)
		UNION ALL
SELECT person_id
			,measurement_date AS eventDate
			,measurement_concept_id AS eventConceptId
			,'LabTsh' AS eventType
			,value_as_number AS eventNumValue
			,NULL AS eventStringValue
--		    ,value_as_string AS eventStringValue
		FROM measurement
        WHERE measurement_concept_id IN (3001019,3004094,3005832,3006499,3007383,3015011,3019025,3028165,3044958,3048812,3051689,40759714,40761927,3006977,3030538,3035921,3038819,3040341,3045302,3046029,3052637,40760963,3004135,3011025,3017564,3027700,3030381,3030695,3050085,3052705,3005961,3006721,3009559,3017044,3019762,3030198,3040558,40760528,40768056,3005758,3011450,3016606,3017338,3029985,3052034,40766098,42870560,3009621,3014707,3019170,3028037,3030277,3037142,3040751,40758491,3028091,3029973,3040407,40766096,3001592,3016692,3016806,3030379,3037152,3043515,3051723,40766097,3003316,3008795,3016152,3016735,3027387,3045848,3052951,40761928,3009142,3013943,3024528,3030188,3032069,3038369,40758591,40766095,3047177,3029406,3001281,3005951,3030362,3005711,3030018,3002382,3006939,3018930,3022769,3047203,3009201,3023399,3038221,3015559,3034211,3034732,3014422,3019927)
		UNION ALL
		/*Case Lab TSH not IN 6 month before pregnancy to one year after pregnancy */
		SELECT person_id
			,measurement_date AS eventDate
			,measurement_concept_id AS eventConceptId
			,'LabTshNoPregnancy' AS eventType
			,value_as_number AS eventNumValue
			,NULL AS eventStringValue
--		    ,value_as_string AS eventStringValue
		FROM measurement
        WHERE measurement_concept_id IN (3001019,3004094,3005832,3006499,3007383,3015011,3019025,3028165,3044958,3048812,3051689,40759714,40761927,3006977,3030538,3035921,3038819,3040341,3045302,3046029,3052637,40760963,3004135,3011025,3017564,3027700,3030381,3030695,3050085,3052705,3005961,3006721,3009559,3017044,3019762,3030198,3040558,40760528,40768056,3005758,3011450,3016606,3017338,3029985,3052034,40766098,42870560,3009621,3014707,3019170,3028037,3030277,3037142,3040751,40758491,3028091,3029973,3040407,40766096,3001592,3016692,3016806,3030379,3037152,3043515,3051723,40766097,3003316,3008795,3016152,3016735,3027387,3045848,3052951,40761928,3009142,3013943,3024528,3030188,3032069,3038369,40758591,40766095,3047177,3029406,3001281,3005951,3030362,3005711,3030018,3002382,3006939,3018930,3022769,3047203,3009201,3023399,3038221,3015559,3034211,3034732,3014422,3019927)
		AND person_id NOT IN (SELECT person_id FROM ph_hypotmppregnancy)
		UNION ALL
		SELECT person_id
			,measurement_date AS eventDate
			,measurement_concept_id AS eventConceptId
			,'LabTshNoPregnancy' AS eventType
			,value_as_number AS eventNumValue
			,NULL AS eventStringValue
--		    ,value_as_string AS eventStringValue
		FROM measurement OS
        WHERE measurement_concept_id IN (3001019,3004094,3005832,3006499,3007383,3015011,3019025,3028165,3044958,3048812,3051689,40759714,40761927,3006977,3030538,3035921,3038819,3040341,3045302,3046029,3052637,40760963,3004135,3011025,3017564,3027700,3030381,3030695,3050085,3052705,3005961,3006721,3009559,3017044,3019762,3030198,3040558,40760528,40768056,3005758,3011450,3016606,3017338,3029985,3052034,40766098,42870560,3009621,3014707,3019170,3028037,3030277,3037142,3040751,40758491,3028091,3029973,3040407,40766096,3001592,3016692,3016806,3030379,3037152,3043515,3051723,40766097,3003316,3008795,3016152,3016735,3027387,3045848,3052951,40761928,3009142,3013943,3024528,3030188,3032069,3038369,40758591,40766095,3047177,3029406,3001281,3005951,3030362,3005711,3030018,3002382,3006939,3018930,3022769,3047203,3009201,3023399,3038221,3015559,3034211,3034732,3014422,3019927)
		AND person_id IN (SELECT person_id FROM ph_hypotmppregnancy)
		AND ((extract(year from age(CAST((SELECT minPregnancyDate FROM ph_hypotmppregnancy TP WHERE TP.person_id = OS.person_id) AS DATE), CAST(measurement_date AS DATE)))*12 + extract(month from age(CAST((SELECT minPregnancyDate FROM ph_hypotmppregnancy TP WHERE TP.person_id = OS.person_id) AS DATE), CAST(measurement_date AS DATE)))) > 6 
		OR (EXTRACT(YEAR FROM CAST(measurement_date AS DATE)) - EXTRACT(YEAR FROM CAST((SELECT maxPregnancyDate FROM ph_hypotmppregnancy TP WHERE TP.person_id = OS.person_id) AS DATE))) > 1 )
		UNION ALL
		SELECT person_id
			,measurement_date AS eventDate
			,measurement_concept_id AS eventConceptId
			,'LabAntiThyroglobulin' AS eventType
			,value_as_number AS eventNumValue
			,NULL AS eventStringValue		
--		    ,value_as_string AS eventStringValue
		FROM measurement
        WHERE measurement_concept_id IN (3006219,40766092,3050633,3052732,3012085,40760890,3024857,40766091,3021200,3040051,3025547,40759656,40759754)
		UNION ALL
		/*Case Lab AntiThyroglobulin not IN 6 month before pregnancy to one year after pregnancy */
		SELECT person_id
			,measurement_date AS eventDate
			,measurement_concept_id AS eventConceptId
			,'LabAntiThyroglobulinNoPregnancy' AS eventType
			,value_as_number AS eventNumValue
			,NULL AS eventStringValue		
--		    ,value_as_string AS eventStringValue
		FROM measurement
        WHERE measurement_concept_id IN (3006219,40766092,3050633,3052732,3012085,40760890,3024857,40766091,3021200,3040051,3025547,40759656,40759754)
		AND person_id NOT IN (SELECT person_id FROM ph_hypotmppregnancy)
		UNION ALL
		SELECT person_id
			,measurement_date AS eventDate
			,measurement_concept_id AS eventConceptId
			,'LabAntiThyroglobulinNoPregnancy' AS eventType
			,value_as_number AS eventNumValue
			,NULL AS eventStringValue		
--		    ,value_as_string AS eventStringValue
		FROM measurement OS
        WHERE measurement_concept_id IN (3006219,40766092,3050633,3052732,3012085,40760890,3024857,40766091,3021200,3040051,3025547,40759656,40759754)
		AND person_id IN (SELECT person_id FROM ph_hypotmppregnancy)
		AND ((extract(year from age(CAST((SELECT minPregnancyDate FROM ph_hypotmppregnancy TP WHERE person_id = OS.person_id) AS DATE), CAST(measurement_date AS DATE)))*12 + extract(month from age(CAST((SELECT minPregnancyDate FROM ph_hypotmppregnancy TP WHERE person_id = OS.person_id) AS DATE), CAST(measurement_date AS DATE)))) > 6 
		OR (EXTRACT(YEAR FROM CAST(measurement_date AS DATE)) - EXTRACT(YEAR FROM CAST((SELECT maxPregnancyDate FROM ph_hypotmppregnancy TP WHERE TP.person_id = OS.person_id) AS DATE))) > 1 )
		UNION ALL
		SELECT person_id
			,measurement_date AS eventDate
			,measurement_concept_id AS eventConceptId
			,'LabFt4' AS eventType
			,value_as_number AS eventNumValue
			,NULL AS eventStringValue		
--		    ,value_as_string AS eventStringValue
		FROM measurement
        WHERE measurement_concept_id IN (3001019,3016104,3040497,42868691,3028169,3015803,3016363,3039354,40760108,3028779,3007253,40760107,40761930,3024675,3026791,40761932,3020434,40760106,43533580,3004111,3008486,3016943,40760105,3006153,3032600,40761931,3004006,3000551,3008598,3011818)
		UNION ALL
		/*Case LabFt4 not IN 6 month before pregnancy to one year after pregnancy */
		SELECT person_id
			,measurement_date AS eventDate
			,measurement_concept_id AS eventConceptId
			,'LabFt4NoPregnancy' AS eventType
			,value_as_number AS eventNumValue
			,NULL AS eventStringValue		
--		    ,value_as_string AS eventStringValue
		FROM measurement
        WHERE measurement_concept_id IN (3001019,3016104,3040497,42868691,3028169,3015803,3016363,3039354,40760108,3028779,3007253,40760107,40761930,3024675,3026791,40761932,3020434,40760106,43533580,3004111,3008486,3016943,40760105,3006153,3032600,40761931,3004006,3000551,3008598,3011818)
		AND person_id NOT IN (SELECT person_id FROM ph_hypotmppregnancy)
		UNION ALL
		SELECT person_id
			,measurement_date AS eventDate
			,measurement_concept_id AS eventConceptId
			,'LabFt4NoPregnancy' AS eventType
			,value_as_number AS eventNumValue
			,NULL AS eventStringValue
--		    ,value_as_string AS eventStringValue
		FROM measurement OS
        WHERE measurement_concept_id IN (3001019,3016104,3040497,42868691,3028169,3015803,3016363,3039354,40760108,3028779,3007253,40760107,40761930,3024675,3026791,40761932,3020434,40760106,43533580,3004111,3008486,3016943,40760105,3006153,3032600,40761931,3004006,3000551,3008598,3011818)
		AND person_id IN (SELECT person_id FROM ph_hypotmppregnancy)
		AND ((extract(year from age(CAST((SELECT minPregnancyDate FROM ph_hypotmppregnancy TP WHERE TP.person_id = OS.person_id) AS DATE), CAST(measurement_date AS DATE)))*12 + extract(month from age(CAST((SELECT minPregnancyDate FROM ph_hypotmppregnancy TP WHERE TP.person_id = OS.person_id) AS DATE), CAST(measurement_date AS DATE)))) > 6 
		OR (EXTRACT(YEAR FROM CAST(measurement_date AS DATE)) - EXTRACT(YEAR FROM CAST((SELECT maxPregnancyDate FROM ph_hypotmppregnancy TP WHERE TP.person_id = OS.person_id) AS DATE))) > 1 )
		UNION ALL
		SELECT person_id
			,measurement_date AS eventDate
			,measurement_concept_id AS eventConceptId
			,'LabAntiThyroperoxidase' AS eventType
			,value_as_number AS eventNumValue
			,NULL AS eventStringValue
--		    ,value_as_string AS eventStringValue
		FROM measurement
        WHERE measurement_concept_id IN (3008641,3015352,3035973,40766093,3020266,40766094,3027238,3028612,3025760,3025251,40759598,3005908,3043429)
		UNION ALL
		/*Case LabAntiThyroperoxidase not IN 6 month before pregnancy to one year after pregnancy */
		SELECT person_id
			,measurement_date AS eventDate
			,measurement_concept_id AS eventConceptId
			,'LabAntiThyroperoxidaseNoPregnancy' AS eventType
			,value_as_number AS eventNumValue
			,NULL AS eventStringValue
--		    ,value_as_string AS eventStringValue
		FROM measurement
        WHERE measurement_concept_id IN (3008641,3015352,3035973,40766093,3020266,40766094,3027238,3028612,3025760,3025251,40759598,3005908,3043429)
		AND person_id NOT IN (SELECT person_id FROM ph_hypotmppregnancy)
		UNION ALL
		SELECT person_id
			,measurement_date AS eventDate
			,measurement_concept_id AS eventConceptId
			,'LabAntiThyroperoxidaseNoPregnancy' AS eventType
			,value_as_number AS eventNumValue
			,NULL AS eventStringValue
--		    ,value_as_string AS eventStringValue
		FROM measurement OS
        WHERE measurement_concept_id IN (3008641,3015352,3035973,40766093,3020266,40766094,3027238,3028612,3025760,3025251,40759598,3005908,3043429)
		AND person_id IN (SELECT person_id FROM ph_hypotmppregnancy)
		AND ((extract(year from age(CAST((SELECT minPregnancyDate FROM ph_hypotmppregnancy TP WHERE TP.person_id = OS.person_id) AS DATE), CAST(measurement_date AS DATE)))*12 + extract(month from age(CAST((SELECT minPregnancyDate FROM ph_hypotmppregnancy TP WHERE TP.person_id = OS.person_id) AS DATE), CAST(measurement_date AS DATE)))) > 6 
		OR (EXTRACT(YEAR FROM CAST(measurement_date AS DATE)) - EXTRACT(YEAR FROM CAST((SELECT maxPregnancyDate FROM ph_hypotmppregnancy TP WHERE TP.person_id = OS.person_id) AS DATE))) > 1 )
		/* NLP part */
		/* Control contains >=2 PMH and MEDS */
		-- UNION ALL
		-- SELECT person_id
		-- 	,noteDate AS eventDate
		-- 	,ph_hypoalgvar AS eventConceptId
		-- 	,'pmhNtExistence' AS eventType
		-- 	,NULL AS eventNumValue
		--     ,NULL AS eventStringValue
		-- FROM nlpNoteVisit
		-- WHERE ph_hypoalgvar = 'pmh.note.existence'
		) U ON P0.person_id = U.person_id
	) Utotal;
/* *** BLOCK 2: Get algorithm related variables *** */
-- IF OBJECT_ID('tempdb..#ph_hypoalgvar') IS NOT NULL
-- 	DROP TABLE ph_hypoalgvar;
set search_path to omop;
CREATE TABLE ph_hypoalgvar_days  (person_id INT NOT NULL
	,diseaseName VARCHAR(50) NOT NULL
	,caseControl VARCHAR(50) NOT NULL
	,C00 INT NOT NULL
	,C01 INT NOT NULL
	,C02 INT NOT NULL
	,C03 INT NOT NULL
	,C04 INT NOT NULL
	,C05 INT NOT NULL
	,C06 INT NOT NULL
	,C07 INT NOT NULL
	,C08 INT NOT NULL
	,C09 INT NOT NULL
	,C10 INT NOT NULL
	,C11 INT NOT NULL
	,C12 INT NOT NULL
	,C13 INT NOT NULL /* Control contains >=2 PMH and MEDS */
	);
INSERT INTO ph_hypoalgvar_days 
SELECT DISTINCT J.person_id
	,'Hypothyroidism' AS diseaseName
	,'CASE/CONTROL' AS caseControl
	,COALESCE(J0.dxHypothyroidismCnt,0) AS C00
	,COALESCE(J1.dxHypothyroidismNoPregnancyCnt,0) AS C01
	,COALESCE(J2.labTshFt4CaseCnt,0) AS C02
	,COALESCE(J3.labTshFt4CtrlCnt,0) AS C03
	,COALESCE(J4.rxCaseCnt,0) AS C04
	,COALESCE(J5.rxThyroidAlteringCnt,0) AS C05
-- 	,COALESCE(J6.timeDiffRxLab,0) AS C06
	,COALESCE(J6.daysDiffRxLab,0) AS C06 
	,COALESCE(J7.procRadiationCnt,0) AS C07
	,COALESCE(J8.dxCaseCtrlExclCnt,0) AS C08
	,COALESCE(J9.procThyroidectomyCnt,0) AS C09
	,COALESCE(J10.dxCtrlExclCnt,0) AS C10
	,COALESCE(J11.rxAnyMedCnt,0) AS C11
	,COALESCE(J12.rxCaseNoPregnancyCnt,0) AS C12
	,COALESCE(J13.notesPMHsecCnt,0) AS C13
FROM eMergeCohort2 J
LEFT JOIN (
	SELECT person_id
		,COUNT(DISTINCT eventDate) AS dxHypothyroidismCnt
	FROM ph_hypotmp
	WHERE eventType = 'DxHypothyroidism' 
	GROUP BY person_id
	) J0 
ON J.person_id = J0.person_id
LEFT JOIN (
	SELECT person_id
		,COUNT(DISTINCT eventDate) AS dxHypothyroidismNoPregnancyCnt
	FROM ph_hypotmp
	WHERE eventType = 'DxHypothyroidismNoPregnancy' 
	GROUP BY person_id
	) J1 
ON J.person_id = J1.person_id
LEFT JOIN (
	SELECT person_id
		,COUNT(DISTINCT eventDate) AS labTshFt4CaseCnt
	FROM ph_hypotmp
	WHERE (eventType = 'LabTshNoPregnancy' AND eventNumValue > 5) 
	OR (eventType = 'LabFt4NoPregnancy' AND eventNumValue < 0.5) 
	GROUP BY person_id
	) J2 
ON J.person_id = J2.person_id
LEFT JOIN (
	SELECT person_id
		,COUNT(DISTINCT eventDate) AS labTshFt4CtrlCnt
	FROM ph_hypotmp
	WHERE (eventType = 'LabTsh' AND eventNumValue <= 0.5 AND eventNumValue <= 5) 
	OR (eventType = 'LabFt4' AND eventNumValue >= 9.5) 
	GROUP BY person_id
	) J3 
ON J.person_id = J3.person_id
LEFT JOIN (
	SELECT person_id
		,COUNT(DISTINCT eventDate) AS rxCaseCnt
	FROM ph_hypotmp
	WHERE eventType = 'RxCase' 
	GROUP BY person_id
	) J4 
ON J.person_id = J4.person_id
LEFT JOIN (
	SELECT person_id
		,COUNT(DISTINCT eventDate) AS rxThyroidAlteringCnt
	FROM ph_hypotmp
	WHERE eventType = 'RxThyroidAltering' 
	GROUP BY person_id
	) J5 
ON J.person_id = J5.person_id
/*at least 2 instances of either medication or lab with at least 3 months between the first and last instance of medication or lab */
LEFT JOIN (
	SELECT person_id
		,(extract(year from age(CAST(MAX(eventDate) AS DATE), CAST(MIN(eventDate) AS DATE)))*12 + extract(month from age(CAST(MAX(eventDate) AS DATE), CAST(MIN(eventDate) AS DATE)))) AS timeDiffRxLab
	       ,(MAX(eventDate) - MIN(eventDate)) AS daysDiffRxLab

	FROM ph_hypotmp
	WHERE eventType = 'RxCaseNoPregnancy' 
	OR (eventType = 'LabTshNoPregnancy' AND eventNumValue > 5) 
	OR (eventType = 'LabFt4NoPregnancy' AND eventNumValue < 0.5) 
	OR (eventType = 'LabAntiThyroperoxidaseNoPregnancy' AND eventNumValue > 34) 
	OR (eventType = 'LabAntiThyroglobulinNoPregnancy' AND eventNumValue > 39) 
	GROUP BY person_id
	HAVING (MAX(eventDate) - MIN(eventDate)) >= 90

	) J6 
ON J.person_id = J6.person_id
LEFT JOIN (
	SELECT person_id
		,COUNT(DISTINCT eventDate) AS procRadiationCnt
	FROM ph_hypotmp
	WHERE eventType = 'ProcRadiation' 
	GROUP BY person_id
	) J7 
ON J.person_id = J7.person_id
LEFT JOIN (
	SELECT person_id
		,COUNT(DISTINCT eventDate) AS dxCaseCtrlExclCnt
	FROM ph_hypotmp
	WHERE eventType = 'DxCaseCtrlExcl' 
	GROUP BY person_id
	) J8 
ON J.person_id = J8.person_id
LEFT JOIN (
	SELECT person_id
		,COUNT(DISTINCT eventDate) AS procThyroidectomyCnt
	FROM ph_hypotmp
	WHERE eventType = 'ProcThyroidectomy' 
	GROUP BY person_id
	) J9 
ON J.person_id = J9.person_id
LEFT JOIN (
	SELECT person_id
		,COUNT(DISTINCT eventDate) AS dxCtrlExclCnt
	FROM ph_hypotmp
	WHERE eventType = 'DxCtrlExcl' 
	GROUP BY person_id
	) J10 
ON J.person_id = J10.person_id
LEFT JOIN (
	SELECT person_id
		,COUNT(DISTINCT eventDate) AS rxAnyMedCnt
	FROM ph_hypotmp
	WHERE eventType = 'RxAnyMed' 
	GROUP BY person_id
	) J11 
ON J.person_id = J11.person_id
LEFT JOIN (
	SELECT person_id
		,COUNT(DISTINCT eventDate) AS rxCaseNoPregnancyCnt
	FROM ph_hypotmp
	WHERE eventType = 'RxCaseNoPregnancy' 
	GROUP BY person_id
	) J12 
ON J.person_id = J12.person_id
LEFT JOIN (
	SELECT person_id
		,COUNT(DISTINCT eventDate) AS notesPMHsecCnt
	FROM ph_hypotmp
	WHERE eventType = 'pmhNtExistence' 
	GROUP BY person_id
	) J13 
ON J.person_id = J13.person_id
;
/* *** BLOCK 3: Phenotyping **** */
-- IF OBJECT_ID('tempdb..#ph_hypophenotype') IS NOT NULL
-- 	DROP TABLE ph_hypophenotype;
CREATE TABLE ph_hypophenotype_days  (person_id INT
	,pCase VARCHAR(50)
	,pCtrl VARCHAR(50)
	);
INSERT INTO ph_hypophenotype_days
SELECT DISTINCT CL.person_id /* CL has duplicate person_id */
	,COALESCE(U1.ph_hypophenotype,'NO') AS pCase
	,COALESCE(U2.ph_hypophenotype,'NO') AS pCtrl
FROM eMergeCohort2 CL
LEFT JOIN (
	SELECT DISTINCT person_id
		,'YES' AS ph_hypophenotype
	FROM ph_hypoalgvar_days 
	WHERE (
			(C01 >0 OR
			C02 >0 ) AND
			C12 > 0 AND
-- 			C06 >= 3 AND
			C06 >=90 AND
			C07 =0 AND
			C08 = 0 AND
			C09 =0 AND
			C05 = 0
			)
	) U1 ON CL.person_id = U1.person_id
LEFT JOIN (
	SELECT DISTINCT person_id
		,'YES' AS ph_hypophenotype
	FROM ph_hypoalgvar_days 
	WHERE (
			C00 = 0 AND
			C04 = 0 AND
			C03 > 0 AND
			C11 + C13 >= 2 AND
			C05 =0 AND
			C07 = 0 AND
			C08 = 0 AND
			C09 = 0 AND
			C10 = 0 
			)
	) U2 ON CL.person_id = U2.person_id;
/* *** For phekb submission *** */
SELECT person_id AS eMERGE_ID
	,CASE WHEN pCase = 'YES' THEN 'C49152'
		WHEN pCtrl = 'YES' THEN 'C28143'
		WHEN pCase = 'NO' AND pCtrl = 'NO' THEN 'NO' END AS Case_Control
FROM ph_hypophenotype
ORDER BY eMERGE_ID
;
CREATE TABLE ph_hypophenotype_result_days (person_id INT,
									case_control TEXT
);
INSERT INTO ph_hypophenotype_result_days (
SELECT person_id AS eMERGE_ID
	,CASE WHEN pCase = 'YES' THEN 'C49152'
		WHEN pCtrl = 'YES' THEN 'C28143'
		WHEN pCase = 'NO' AND pCtrl = 'NO' THEN 'NO' END AS Case_Control
FROM ph_hypophenotype_days )
;




