SET search_path TO omop;

/* *** BLOCK 1: Extract relevant data element FROM source data and store in #ph_herpeszostertmp *** */
-- IF OBJECT_ID('tempdb..#ph_herpeszostertmp') IS NOT NULL
	-- DROP TABLE ph_herpeszostertmp;
CREATE TABLE ph_herpeszostertmp  (person_id INT
	,eventDate DATE
	,eventConceptId VARCHAR(100)
	,eventType VARCHAR(100)
	,eventNumValue FLOAT NULL
	,eventStringValue VARCHAR(100) NULL
	);
INSERT INTO ph_herpeszostertmp
SELECT DISTINCT *
FROM (
	SELECT P0.person_id
		,U.eventDate
		,U.eventConceptId
		,U.eventType
		,U.eventNumValue
		,U.eventStringValue
	FROM eMergeCohort_all P0
	LEFT JOIN (
		SELECT person_id	
        ,CAST(CAST(year_of_birth AS varchar) || '-' || CAST(month_of_birth AS varchar) || '-' || CAST(day_of_birth AS varchar) AS date) AS eventDate
		,NULL AS eventConceptId
		,'Birthday' AS eventType
        ,CAST(NULL AS FLOAT) AS eventNumValue
        ,CAST(NULL AS varchar(100)) AS eventStringValue
	    FROM person
	  	UNION ALL
    	SELECT person_id
			,condition_start_date AS eventDate
			,condition_concept_id AS eventConceptId
			,'DxHerpesZoster' AS eventType
			,NULL AS eventNumValue
		    ,NULL AS eventStringValue
		FROM condition_occurrence
		-- WHERE condition_concept_id IN ('21013407','21000169','21000166','21000167','21000165','21000168','21004617','372828','443943','138682','138965','192239','373412','381504','432546','438961','440323','4045976','376028','436336','437489','440329','35607128','36110918','36110920','35406348','36109991','36110924','36718098')
		WHERE condition_concept_id IN (21013407,21000169,21000166,21000167,21000165,21000168,21004617,372828,443943,138682,138965,192239,373412,381504,432546,438961,440323,4045976,376028,436336,437489,440329,35607128,36110918,36110920,35406348,36109991,36110924,36718098)
        UNION ALL
    	SELECT person_id
			,condition_start_date AS eventDate
			,condition_concept_id AS eventConceptId
			,'DxVaricellaZoster' AS eventType
			,NULL AS eventNumValue
		    ,NULL AS eventStringValue
		FROM condition_occurrence
		-- WHERE condition_concept_id IN ('21007278','256036','380322','434272','437791','36009875','36110929','36110930')
		WHERE condition_concept_id IN (21007278,256036,380322,434272,437791,36009875,36110929,36110930)
        UNION ALL
    	SELECT person_id
			,condition_start_date AS eventDate
			,condition_concept_id AS eventConceptId
			,'DxHiv' AS eventType
			,NULL AS eventNumValue
		    ,NULL AS eventStringValue
		FROM condition_occurrence
		-- WHERE condition_concept_id IN ('21000158','21000160','21000161','21000162','21000397','21000885','21004037','21004839','21007238','21007244','21007245','21007278','21013495','21013812','40249000','439727','36009928')
		WHERE condition_concept_id IN (21000158,21000160,21000161,21000162,21000397,21000885,21004037,21004839,21007238,21007244,21007245,21007278,21013495,21013812,40249000,439727,36009928)        UNION ALL
    	SELECT person_id
			,condition_start_date AS eventDate
			,condition_concept_id AS eventConceptId
			,'DxMarrowCancer' AS eventType
			,NULL AS eventNumValue
		    ,NULL AS eventStringValue
		FROM condition_occurrence
		-- WHERE condition_concept_id IN ('21000458','21000481','21000486','21000492','21003398','21011867','21013405','21013418','43534923','21000473','21000474','21000484','21013769','21000493','21000494','21013409','21013410','21000489','21000490','21008923','21013537','21013538','21013661','21013946','21000477','21000482','21013939','21000483','21013699','21000487','21000488','21013403','21013687','21013688','21000471','21000479','21000485','40248985','21000475','21000495','21002917','132575','132852','132853','133154','133158','134305','134597','134603','134879','135214','135499','135496','135764','135766','135768','136056','136367','136656','136655','136928','136930','138099','138377','138379','138708','140057','140352','140663','140666','140672','140967','141243','141524','141814','192268','193157','193429','193427','193434','194593','194594','194876','195196','195761','196355','196363','196650','197816','198381','198372','198704','198710','198986','199760','200355','200662','201242','201811','201813','313159','313430','313980','314600','315202','315497','315763','316356','316649','317510','318989','320049','320337','321522','321526','373152','432267','432571','433161','433156','434299','434302','434599','434595','434877','434881','435203','435494','436362','436652','436920','437233','437817','438373','438703','438709','439282','439281','439285','439291','439761','440059','440351','440354','440964','440965','441235','441523','442092','442093','442094','442095','442144','442145','442150','442151','442153','442152','442155','442154','442146','442156','442162','442163','442160','442157','442158','442161','442159','442169','442168','444465','444466','444467','4038841','4038835','4038842','4038839','4038840','4038843','4040379','4041104','4041797','4041798','4041800','4041799','4082488','4143848','4149840','4247726','4278365','40481901','40490918','134596','135759','135765','135762','138378','139759','140664','192270','192265','193721','194878','195195','195201','195760','196058','197232','198088','198098','198374','198707','199762','200338','200349','200660','200659','318382','318697','320347','321815','435200','435193','435495','435492','435758','436059','436651','436929','437505','437818','439267','439265','439270','440058','440957','441241','441525','441812','442128','4038838','4040380','4091930','4097579','4138466','132850','135204','197509','4139054','4143382','4245460','132841','133438','137512','192560','197511','198705','200343','200667','434601','435207','435753','438106','438698','440350','441245','441521','4091914','4091905','4094541','4094542','4096967','4096968','4097571','4121332','4173971','132572','141816','193428','196055','315481','444440','434592','443719','135194','197228','198702','201807','201810','433426','438376','441803','4091768','4097561','4097560','40479608','40482893','437504','438380','4096955','432574','40481357','443743','35104227','35104237','35104239','35104246','35104255','35104323','35104325','35104326','35104336','35104347','35104337','35104341','35104339','35104349','35104350','35104348','35104351','35104358','35104357','35104356','35104353','35104374','35104359','35104366','35104364','35104378','35104382','35104385','35104390','35104386','35104392','35104391','35104395','35104405','35104408','35104409','35104410','35104411','35104421','35104422','35104432','35104433','35104423','35104443','35104442','35104434','35104452','35104444','35104453','35104457','35104454','35104461','35104464','35104465','35104483','35104490','35104532','35104583','35104618','35104624','35104625','35104643','35104665','35104666','35104667','4136153','4172372','4233385','35104245','35104352','35104383','35104396','35104471','35104469','35104468','35104470','35104489','35104494','35104493','35104496','35104495','35104539','35104646','35104648','35104649','35104393','35104365','35104340','35104379','35104487','35104486','35104488','35104560','35104497','35104647')
		WHERE condition_concept_id IN (21000458,21000481,21000486,21000492,21003398,21011867,21013405,21013418,43534923,21000473,21000474,21000484,21013769,21000493,21000494,21013409,21013410,21000489,21000490,21008923,21013537,21013538,21013661,21013946,21000477,21000482,21013939,21000483,21013699,21000487,21000488,21013403,21013687,21013688,21000471,21000479,21000485,40248985,21000475,21000495,21002917,132575,132852,132853,133154,133158,134305,134597,134603,134879,135214,135499,135496,135764,135766,135768,136056,136367,136656,136655,136928,136930,138099,138377,138379,138708,140057,140352,140663,140666,140672,140967,141243,141524,141814,192268,193157,193429,193427,193434,194593,194594,194876,195196,195761,196355,196363,196650,197816,198381,198372,198704,198710,198986,199760,200355,200662,201242,201811,201813,313159,313430,313980,314600,315202,315497,315763,316356,316649,317510,318989,320049,320337,321522,321526,373152,432267,432571,433161,433156,434299,434302,434599,434595,434877,434881,435203,435494,436362,436652,436920,437233,437817,438373,438703,438709,439282,439281,439285,439291,439761,440059,440351,440354,440964,440965,441235,441523,442092,442093,442094,442095,442144,442145,442150,442151,442153,442152,442155,442154,442146,442156,442162,442163,442160,442157,442158,442161,442159,442169,442168,444465,444466,444467,4038841,4038835,4038842,4038839,4038840,4038843,4040379,4041104,4041797,4041798,4041800,4041799,4082488,4143848,4149840,4247726,4278365,40481901,40490918,134596,135759,135765,135762,138378,139759,140664,192270,192265,193721,194878,195195,195201,195760,196058,197232,198088,198098,198374,198707,199762,200338,200349,200660,200659,318382,318697,320347,321815,435200,435193,435495,435492,435758,436059,436651,436929,437505,437818,439267,439265,439270,440058,440957,441241,441525,441812,442128,4038838,4040380,4091930,4097579,4138466,132850,135204,197509,4139054,4143382,4245460,132841,133438,137512,192560,197511,198705,200343,200667,434601,435207,435753,438106,438698,440350,441245,441521,4091914,4091905,4094541,4094542,4096967,4096968,4097571,4121332,4173971,132572,141816,193428,196055,315481,444440,434592,443719,135194,197228,198702,201807,201810,433426,438376,441803,4091768,4097561,4097560,40479608,40482893,437504,438380,4096955,432574,40481357,443743,35104227,35104237,35104239,35104246,35104255,35104323,35104325,35104326,35104336,35104347,35104337,35104341,35104339,35104349,35104350,35104348,35104351,35104358,35104357,35104356,35104353,35104374,35104359,35104366,35104364,35104378,35104382,35104385,35104390,35104386,35104392,35104391,35104395,35104405,35104408,35104409,35104410,35104411,35104421,35104422,35104432,35104433,35104423,35104443,35104442,35104434,35104452,35104444,35104453,35104457,35104454,35104461,35104464,35104465,35104483,35104490,35104532,35104583,35104618,35104624,35104625,35104643,35104665,35104666,35104667,4136153,4172372,4233385,35104245,35104352,35104383,35104396,35104471,35104469,35104468,35104470,35104489,35104494,35104493,35104496,35104495,35104539,35104646,35104648,35104649,35104393,35104365,35104340,35104379,35104487,35104486,35104488,35104560,35104497,35104647)       
        UNION ALL
		SELECT person_id
			,procedure_date AS eventDate
			,procedure_concept_id AS eventConceptId
			,'ProcChemo' AS eventType
			,NULL AS eventNumValue
		    ,NULL AS eventStringValue
		FROM procedure_occurrence
		-- WHERE procedure_concept_id IN ('2314231','2314227','2314229','2314225','2314220','2314221','2314222','2314223','2314233','2314236','2314237','2314232','2314240','2314238','2314235','2314234','2314246','2314248','2314257','2314255','2314256','42732724','42732725','42732723','42732722','42738941','42739887','42738932','42738936','2110448','2000011','2008271','2616278','2616276','2616277','2617778','2617779','2617781','2617780','2720578','2720576','2720574','2720577','2721477','2721478','2721476')
		WHERE procedure_concept_id IN (2314231,2314227,2314229,2314225,2314220,2314221,2314222,2314223,2314233,2314236,2314237,2314232,2314240,2314238,2314235,2314234,2314246,2314248,2314257,2314255,2314256,42732724,42732725,42732723,42732722,42738941,42739887,42738932,42738936,2110448,2000011,2008271,2616278,2616276,2616277,2617778,2617779,2617781,2617780,2720578,2720576,2720574,2720577,2721477,2721478,2721476)       
        UNION ALL
    	SELECT person_id
	      ,visit_start_date AS eventDate
	      , NULL AS eventConceptId
	      ,'Visit' AS eventType
	      ,NULL AS eventNumValue
		,NULL AS eventStringValue
		FROM visit_occurrence
		) U ON P0.person_id = U.person_id
	) Utotal;
/* *** BLOCK Data Preparation: Need Age *** */
-- IF OBJECT_ID('tempdb..#ph_herpeszostertmpage') IS NOT NULL
	-- DROP TABLE ph_herpeszostertmpage;
CREATE TABLE ph_herpeszostertmpage  (person_id INT
	,birthDate DATE
	);
INSERT INTO ph_herpeszostertmpage
/* source data is not accurate, one person may have more than one birth-date */
SELECT DISTINCT person_id
	,MIN(eventDate) AS birthDate
FROM ph_herpeszostertmp
WHERE eventType = 'Birthday'
GROUP BY person_id;
/* *** BLOCK Data Preparation: Need Case Index date *** */
-- IF OBJECT_ID('tempdb..#ph_herpeszostertmp_caseindexdt') IS NOT NULL
	-- DROP TABLE ph_herpeszostertmp_caseindexdt;
CREATE TABLE ph_herpeszostertmp_caseindexdt  (person_id INT
	,indexDate DATE
	);
INSERT INTO ph_herpeszostertmp_caseindexdt
SELECT person_id
, MIN(eventDate) AS indexDate
FROM ph_herpeszostertmp T1
WHERE (eventType = 'DxHerpesZoster' OR eventType = 'DxVaricellaZoster')
AND (EXTRACT(YEAR FROM CAST(eventDate AS DATE)) - EXTRACT(YEAR FROM CAST((SELECT birthDate
	FROM ph_herpeszostertmpage T2
	WHERE T1.person_id=T2.person_id)
	 AS DATE))) >= 40
GROUP BY person_id;
/* *** BLOCK Data Preparation: Continuous Enrollment Based on Visit *** */
-- IF OBJECT_ID('tempdb..#ph_herpeszostertmpvisityear') IS NOT NULL
	-- DROP TABLE ph_herpeszostertmpvisityear;
CREATE TABLE ph_herpeszostertmpvisityear  (
	person_id INT NOT NULL
	,visitYear INT NOT NULL
	);
INSERT INTO ph_herpeszostertmpvisityear
SELECT DISTINCT person_id, visitYear FROM (
SELECT person_id
, EXTRACT(YEAR FROM eventDate) AS visitYear
, COUNT(eventDate) AS visitFreq
FROM ph_herpeszostertmp T1
WHERE eventType = 'Visit'
AND (EXTRACT(YEAR FROM CAST(eventDate AS DATE)) - EXTRACT(YEAR FROM CAST((SELECT birthDate
		FROM ph_herpeszostertmpage T2
		WHERE T1.person_id=T2.person_id)
		 AS DATE))) >= 35
GROUP BY person_id, EXTRACT(YEAR FROM eventDate) ) U
WHERE U.visitFreq >0 ;
/* *** BLOCK 2: Get algorithm related variables *** */
-- IF OBJECT_ID('tempdb..#ph_herpeszosteralgvar') IS NOT NULL
	-- DROP TABLE ph_herpeszosteralgvar;
CREATE TABLE ph_herpeszosteralgvar  (person_id INT NOT NULL
	,diseaseName VARCHAR(50) NOT NULL
	,caseControl VARCHAR(50) NOT NULL
	,C00 INT NOT NULL
	,C01 INT NOT NULL
	,C02 INT NOT NULL
	,C03 INT NOT NULL
	,C04 INT NOT NULL
	,C05 INT NOT NULL
	,C06 INT NOT NULL
	);
INSERT INTO ph_herpeszosteralgvar
SELECT DISTINCT J.person_id
	,'Zoster' AS diseaseName
	,'CASE/CONTROL' AS caseControl
	,COALESCE(J0.age,0) AS C00
	,COALESCE(J1.dxZosterCnt,0) AS C01
	,COALESCE(J2.dxZosterForCaseCnt,0) AS C02
	,COALESCE(J3.contEnrolCnt,0) AS C03
	,COALESCE(J4.dxHivCnt,0) AS C04
	,COALESCE(J5.dxMarrowCancerCnt,0) AS C05
	,COALESCE(J6.procChemoCnt,0) AS C06
FROM eMergeCohort_all J
LEFT JOIN (
SELECT person_id
, (EXTRACT(YEAR FROM CAST(CURRENT_DATE AS DATE)) - EXTRACT(YEAR FROM CAST(eventDate AS DATE))) AS age
FROM ph_herpeszostertmp
WHERE eventType = 'Birthday'
) J0
ON J.person_id = J0.person_id
LEFT JOIN (
	SELECT person_id
		,COUNT(DISTINCT eventDate) AS dxZosterCnt
	FROM ph_herpeszostertmp
	WHERE eventType = 'DxHerpesZoster' OR eventType ='DxVaricellaZoster'
	GROUP BY person_id
	) J1 
ON J.person_id = J1.person_id
LEFT JOIN (
	SELECT person_id
		,COUNT(DISTINCT eventDate) AS dxZosterForCaseCnt
	FROM ph_herpeszostertmp T1
	WHERE (eventType = 'DxHerpesZoster' OR eventType ='DxVaricellaZoster')
	AND (EXTRACT(YEAR FROM CAST(eventDate AS DATE)) - EXTRACT(YEAR FROM CAST((SELECT birthDate
		FROM ph_herpeszostertmpage T2
		WHERE T1.person_id=T2.person_id)
		 AS DATE))) >= 40
	GROUP BY person_id
	) J2 
ON J.person_id = J2.person_id
/* continuous Enrollment */
LEFT JOIN (
    SELECT U.person_id, COUNT(DISTINCT U.startseat) AS contEnrolCnt
    FROM (
        SELECT DISTINCT (
                SELECT a.visitYear
                FROM ph_herpeszostertmpvisityear a
                LEFT JOIN ph_herpeszostertmpvisityear b ON a.visitYear = b.visitYear + 1 
				AND a.person_id = b.person_id
                WHERE b.visitYear + 1 IS NULL
                AND a.visitYear < x1.visitYear
                AND a.person_id = x1.person_id
                ORDER BY visitYear DESC
                LIMIT 1
            ) AS startseat, x1.visitYear AS endseat, x1.person_id
        FROM (
            SELECT x.person_id, x.visitYear
            FROM ph_herpeszostertmpvisityear x
            LEFT JOIN ph_herpeszostertmpvisityear y ON x.visitYear = y.visitYear + 1 
			AND x.person_id = y.person_id
            WHERE y.visitYear + 1 IS NOT NULL
        ) x1
    ) U
    WHERE (U.endseat - U.startseat) + 1 >= 5
    GROUP BY U.person_id
) J3 ON J.person_id = J3.person_id

LEFT JOIN (
	SELECT person_id
		,COUNT(DISTINCT eventDate) AS dxHivCnt
	FROM ph_herpeszostertmp
	WHERE eventType = 'DxHiv'
	GROUP BY person_id
	) J4 
ON J.person_id = J4.person_id
LEFT JOIN (
	SELECT person_id
		,COUNT(DISTINCT eventDate) AS dxMarrowCancerCnt
	FROM ph_herpeszostertmp T
	WHERE eventType = 'DxMarrowCancer' 
	AND (CAST((SELECT indexDate FROM ph_herpeszostertmp_caseindexdt CID WHERE CID.person_id=T.person_id) AS DATE) - CAST(eventDate AS DATE)) <= 365 
	AND (CAST((SELECT indexDate FROM ph_herpeszostertmp_caseindexdt CID WHERE CID.person_id=T.person_id) AS DATE) - CAST(eventDate AS DATE)) >= 0
	GROUP BY person_id
	) J5 
ON J.person_id = J5.person_id
LEFT JOIN (
	SELECT person_id
		,COUNT(DISTINCT eventDate) AS procChemoCnt
	FROM ph_herpeszostertmp T
	WHERE eventType = 'ProcChemo' 
	AND (CAST((SELECT indexDate FROM ph_herpeszostertmp_caseindexdt CID WHERE CID.person_id=T.person_id) AS DATE) - CAST(eventDate AS DATE)) <= 180 
	AND (CAST((SELECT indexDate FROM ph_herpeszostertmp_caseindexdt CID WHERE CID.person_id=T.person_id) AS DATE) - CAST(eventDate AS DATE)) >= 0
	GROUP BY person_id
	) J6 
ON J.person_id = J6.person_id
;
/* *** BLOCK 3: Phenotyping **** */
/*
 * @ diagnosing Zoster
 * C00.age
 * C01.dxZosterCnt
 * C02.dxZosterForCaseCn
 * C03.contEnrolCnt
 * C04.dxHivCnt
 * C05.dxMarrowCancerCnt
 * C06.procChemoCnt 
 */
-- IF OBJECT_ID('tempdb..#ph_herpeszosterphenotype') IS NOT NULL
	-- DROP TABLE ph_herpeszosterphenotype;
CREATE TABLE ph_herpeszosterphenotype  (person_id INT
	,pCase VARCHAR(50)
	,pCtrl VARCHAR(50)
	);
INSERT INTO ph_herpeszosterphenotype
SELECT DISTINCT CL.person_id /* CL has duplicate person_id */
	,COALESCE(U1.ph_herpeszosterphenotype,'NO') AS pCase
	,COALESCE(U2.ph_herpeszosterphenotype,'NO') AS pCtrl
FROM eMergeCohort_all CL
LEFT JOIN (
	SELECT DISTINCT person_id
		,'YES' AS ph_herpeszosterphenotype
	FROM ph_herpeszosteralgvar
	WHERE (
			C00 >= 40 AND
 			C02>=1 AND
 			C03 >0 AND
 			C04<2 AND
 			C05=0 AND
 			C06=0 
			)
	) U1 ON CL.person_id = U1.person_id
LEFT JOIN (
	SELECT DISTINCT person_id
		,'YES' AS ph_herpeszosterphenotype
	FROM ph_herpeszosteralgvar
	WHERE (
			C00 >= 40 AND
 			C03 >=1 AND
 			C04<2 AND
 			C01=0 
			)
	) U2 ON CL.person_id = U2.person_id;
/* *** For phekb submission *** */
SELECT person_id AS eMERGE_ID
	,CASE WHEN pCase = 'YES' THEN 'C49152'
		WHEN pCtrl = 'YES' THEN 'C28143'
		WHEN pCase = 'NO' AND pCtrl = 'NO' THEN 'NO' END AS Case_Control
FROM ph_herpeszosterphenotype
ORDER BY eMERGE_ID;

CREATE TABLE ph_herpeszoster_result(person_id INT,
									case_control TEXT
);
INSERT INTO ph_herpeszoster_result(
SELECT person_id AS eMERGE_ID
	,CASE WHEN pCase = 'YES' THEN 'C49152'
		WHEN pCtrl = 'YES' THEN 'C28143'
		WHEN pCase = 'NO' AND pCtrl = 'NO' THEN 'NO' END AS Case_Control
FROM ph_herpeszosterphenotype)
;



                  